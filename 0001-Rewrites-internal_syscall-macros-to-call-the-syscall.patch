From 6d667159940450ba1ce40b5ea00e8a88a4f7fe21 Mon Sep 17 00:00:00 2001
From: Jim Newsome <jnewsome@torproject.org>
Date: Sat, 2 May 2020 14:55:29 -0500
Subject: [PATCH 1/2] Rewrites internal_syscall macros to call the syscall
 function via PLT

---
 sysdeps/unix/sysv/linux/x86_64/sysdep.h | 52 ++++++++++++++++++++++++-
 1 file changed, 51 insertions(+), 1 deletion(-)

diff --git a/sysdeps/unix/sysv/linux/x86_64/sysdep.h b/sysdeps/unix/sysv/linux/x86_64/sysdep.h
index 189c5fb327..84c401efa9 100644
--- a/sysdeps/unix/sysv/linux/x86_64/sysdep.h
+++ b/sysdeps/unix/sysv/linux/x86_64/sysdep.h
@@ -210,6 +210,13 @@
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
     (long int) resultvar;						\
 })
+#undef internal_syscall0
+#define internal_syscall0(number, dummy...)                                    \
+    ({                                                                         \
+        extern long syscall(long n, ...);                                      \
+        unsigned long int resultvar = syscall(number);                         \
+        (long int)resultvar;                                                   \
+    })
 
 #undef internal_syscall1
 #define internal_syscall1(number, arg1)					\
@@ -224,6 +231,13 @@
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
     (long int) resultvar;						\
 })
+#undef internal_syscall1
+#define internal_syscall1(number, arg1)                                        \
+    ({                                                                         \
+        extern long syscall(long n, ...);                                      \
+        unsigned long int resultvar = syscall(number, arg1);                   \
+        (long int)resultvar;                                                   \
+    })
 
 #undef internal_syscall2
 #define internal_syscall2(number, arg1, arg2)				\
@@ -240,6 +254,13 @@
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
     (long int) resultvar;						\
 })
+#undef internal_syscall2
+#define internal_syscall2(number, arg1, arg2)                                  \
+    ({                                                                         \
+        extern long syscall(long n, ...);                                      \
+        unsigned long int resultvar = syscall(number, arg1, arg2);             \
+        (long int)resultvar;                                                   \
+    })
 
 #undef internal_syscall3
 #define internal_syscall3(number, arg1, arg2, arg3)			\
@@ -258,6 +279,13 @@
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
     (long int) resultvar;						\
 })
+#undef internal_syscall3
+#define internal_syscall3(number, arg1, arg2, arg3)                            \
+    ({                                                                         \
+        extern long syscall(long n, ...);                                      \
+        unsigned long int resultvar = syscall(number, arg1, arg2, arg3);       \
+        (long int)resultvar;                                                   \
+    })
 
 #undef internal_syscall4
 #define internal_syscall4(number, arg1, arg2, arg3, arg4)		\
@@ -278,6 +306,13 @@
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
     (long int) resultvar;						\
 })
+#undef internal_syscall4
+#define internal_syscall4(number, arg1, arg2, arg3, arg4)                      \
+    ({                                                                         \
+        extern long syscall(long n, ...);                                      \
+        unsigned long int resultvar = syscall(number, arg1, arg2, arg3, arg4); \
+        (long int)resultvar;                                                   \
+    })
 
 #undef internal_syscall5
 #define internal_syscall5(number, arg1, arg2, arg3, arg4, arg5)	\
@@ -301,6 +336,14 @@
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
     (long int) resultvar;						\
 })
+#undef internal_syscall5
+#define internal_syscall5(number, arg1, arg2, arg3, arg4, arg5)                \
+    ({                                                                         \
+        extern long syscall(long n, ...);                                      \
+        unsigned long int resultvar =                                          \
+            syscall(number, arg1, arg2, arg3, arg4, arg5);                     \
+        (long int)resultvar;                                                   \
+    })
 
 #undef internal_syscall6
 #define internal_syscall6(number, arg1, arg2, arg3, arg4, arg5, arg6) \
@@ -326,7 +369,14 @@
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
     (long int) resultvar;						\
 })
-
+#undef internal_syscall6
+#define internal_syscall6(number, arg1, arg2, arg3, arg4, arg5, arg6)          \
+    ({                                                                         \
+        extern long syscall(long n, ...);                                      \
+        unsigned long int resultvar =                                          \
+            syscall(number, arg1, arg2, arg3, arg4, arg5, arg6);               \
+        (long int)resultvar;                                                   \
+    })
 
 # define VDSO_NAME  "LINUX_2.6"
 # define VDSO_HASH  61765110
-- 
2.17.1

